## Data Format

### DICOM文件
👉 医学数字成像与通信标准文件
全称是：Digital Imaging and Communications in Medicine (DICOM)。

🔹 解释

DICOM 是国际医学影像领域的通用标准，专门用于：

存储 医学影像（如 CT、MRI、超声、PET 等）。

传输 医学影像及其相关信息（比如病人信息、扫描参数、成像设备信息）。

它不仅仅是一张图片，而是一个包含 影像数据 + 元数据（Metadata） 的文件。

影像数据：CT、MRI 扫描得到的像素/体素矩阵。

元数据：例如病人姓名、检查日期、扫描设备型号、像素间距 (Pixel Spacing)、层厚 (Slice Thickness) 等。

🔹 举例

一份 CT 检查可能会生成几百个 DICOM 文件：

每个 DICOM 文件对应一张 2D 切片图像；

这些文件堆叠起来，就可以还原为 3D 体数据；

里面还能读取体素大小、成像参数，用于计算体积或做 3D 重建。

🔹 中文总结

DICOM 文件 = 医学影像的行业标准格式，里面既有图像（像素/体素），又有扫描和病人相关的描述信息。
<!-- TODO: What is 体素 in data?--> 


## 🏥 常见医学影像文件格式

| 格式 | 中文名称 | 特点 | 常见应用 |
|------|---------|------|----------|
| **DICOM (.dcm)** | 医学数字成像与通信标准 | - 行业标准，包含 **影像数据 + 元数据（病人信息、扫描参数等）**<br>- 支持 2D 切片序列和 3D 体数据<br>- 文件大、冗余信息多 | CT、MRI、超声、PET、放射科日常诊断 |
| **NIfTI (.nii / .nii.gz)** | 神经影像学信息交换格式 | - 专门为医学图像分析设计<br>- 支持 **3D/4D 数据**（体积 + 时间序列）<br>- 元数据比 DICOM 简洁<br>- 压缩版本 `.nii.gz` 常用 | 脑科学 (fMRI, DTI)，科研数据处理 |
| **Analyze 7.5 (.hdr + .img)** | 医学图像分析格式 | - 由 Mayo Clinic 提出<br>- 分为两部分：`.hdr`（头文件，存储元信息），`.img`（图像体数据）<br>- 已逐渐被 NIfTI 取代 | 早期神经影像研究 |
| **MHD / RAW (.mhd + .raw)** | MetaImage 格式 | - `.mhd` 存元信息，`.raw` 存图像数据<br>- 简单灵活，便于科研使用 | 图像处理、仿真软件 (ITK, VTK) |
| **NRRD (.nrrd)** | Nearly Raw Raster Data | - 结构清晰，支持多维数据<br>- 和 ITK/VTK 软件配合使用 | 医学图像科研、可视化 |
| **MINC (.mnc)** | Medical Imaging NetCDF | - 基于 NetCDF，支持复杂元信息<br>- 灵活但社区较小 | 脑影像、医学研究 |
| **MHA (.mha)** | MetaImage 单文件格式 | - 与 `.mhd + .raw` 类似，但所有数据和头信息合并在一个文件中 | 图像科研处理 |


## 数据预处理建议

在医学影像分割任务中，数据预处理是提升模型性能和泛化能力的重要环节。常见的数据预处理方法包括：

1. 标准化/归一化：对CT/MR影像进行窗宽窗位调整或分位数归一化，将像素值归一化到[0,1]或[0,255]区间。
2. 去噪与小连通域移除：利用连通域分析去除体素数较小的噪声区域，提升标签质量。
3. 切片与裁剪：只保留有标注的切片，自动裁剪ROI，减少无关数据。
4. 尺寸统一：将所有切片resize到统一尺寸，便于批量训练。
5. 标签处理：合并/去除不需要的标签，或将语义分割标签转为实例分割标签。
6. 数据增强：训练时可加入旋转、缩放、弹性变形、强度扰动等增强方式。
7. 数据格式转换：将nii、dcm等医学影像格式转换为npy、npz等高效格式，便于快速读取和训练。
8. 空间信息保留：保留像素间距（spacing）、方向等元数据，便于后续结果还原到原始空间。

根据具体任务和数据特点，可灵活选择和组合上述方法。
# MedSAM-PEFT: Medical Image Segmentation with Segment Anything Model

本仓库基于 **MedSAM** 模型，结合参数高效微调（PEFT）方法，对医学图像分割任务进行了实验与结果总结。

---


## CT Image Process
* 1. CT 原始像素值（HU 值）范围太大
    HU 值定义：Hounsfield Unit 是 CT 的标准单位，反映不同组织的相对密度。

    空气 ≈ -1000 HU
    肺组织 ≈ -700 ~ -600 HU
    水 = 0 HU
    软组织（肌肉、肝脏等）≈ 30 ~ 70 HU
    骨骼 ≈ +1000 HU 甚至更高

    👉 这样就导致 原始 CT 图像的动态范围非常大（从 -1000 到 +3000 HU 左右），但我们在某个任务中只关心其中一小段（例如肺结节、肿瘤、骨折）。

    如果直接显示或输入到网络中：
    * 灰度值跨度太大 → 对比度低，细节看不清
    * 多余信息和噪声过多 → 网络学习困难
    * 不同设备/医院的 CT 值可能存在差异 → 模型泛化差

* 2. 窗宽（WW）和窗位（WL）的作用

    窗宽（Window Width, WW）：决定显示的灰度范围宽度。数值越大，显示的组织范围越广，但对比度降低。

    窗位（Window Level, WL）：决定显示的中心 HU 值。通过改变 WL，可以选择关注某一类组织。

    例如：

      * 软组织窗：WW = 400，WL = 40 （突出肝脏、脾脏、肿瘤等软组织）
      * 骨窗：WW = 1500，WL = 300 （突出显示骨骼细节）
      * 肺窗：WW = 1500，WL = -600 （突出显示肺部组织、结节）
   👉 就像给 CT 图像戴上不同的「眼镜」，针对不同组织把它们拉伸到合适的对比度区间。

* 3. 图像截断与归一化
  * 使用 WW/WL 后，超出区间的 HU 值会被截断：
  * 低于 (WL - WW/2) 的值 → 设为最小灰度
  * 高于 (WL + WW/2) 的值 → 设为最大灰度
  * 截断后的范围被线性映射到常用灰度区间：
  * 临床显示：映射到 [0, 255] → 医生肉眼观察
  * 深度学习：映射到 [0, 1] 或 [-1, 1] → 便于模型输入

这样可以：
✔️ 提高对比度，突出目标区域细节
✔️ 减少无关组织和噪声干扰
✔️ 统一数据分布，让训练更稳定

1. 对深度学习任务的好处

分割：例如肿瘤、器官边界更清晰，模型更容易学到边缘特征

检测：目标与背景差异增强，减少误检/漏检

分类：组织的灰度特征更稳定，避免 HU 值范围过大带来的梯度震荡

泛化性：WW/WL 是临床标准，跨医院/设备时差异更小

窗宽窗位处理已经是 医学图像分析的标准步骤，无论是医生阅片还是 AI 训练都离不开它。

### Sanity Check

将裁剪后的图像和标签保存为NIfTI（.nii.gz）文件，便于人工或可视化检查。NIfTI是医学图像领域的标准格式，医生或研究者可以用3D Slicer、ITK-SNAP等专业软件直接打开，直观地检查预处理结果是否正确。
便于可视化：可以快速对比原始图像和标签，发现预处理中的问题（如裁剪、归一化、掩码处理等）。
便于后续处理：如果后续有其他算法或流程需要用到NIfTI格式的数据，这一步可以直接复用。
总结：
保存为NIfTI文件是医学图像处理流程中的常见“中间检查点”，有助于保证数据质量和流程可追溯性。

你可以用3D Slicer或ITK-SNAP同时加载医学图像和标签（分割掩码），进行配准、可视化和检查。方法如下：

1. 3D Slicer
打开3D Slicer。
点击左上角“Add Data”或“加载数据”按钮。
选择你的图像（如xxx_img.nii.gz）和标签（如xxx_gt.nii.gz），可多选。
勾选“Show Options”，确保标签文件（segmentation/label）被识别为“LabelMap”或“Segmentation”类型。
点击“OK”导入。
在左侧“Data”或“层次结构”面板，可以切换显示图像和标签，标签会以彩色叠加在原图上。
可用“Segmentations”模块调整标签显示方式、透明度等。
2. ITK-SNAP
打开ITK-SNAP。
File → Open Main Image，选择你的图像（如xxx_img.nii.gz）。
File → Open Segmentation，选择你的标签（如xxx_gt.nii.gz）。
图像和标签会自动叠加显示，标签区域以彩色高亮。
可用左侧工具栏切换切片、调整标签透明度、颜色等。
总结：

两个软件都支持NIfTI格式，图像和标签可同时加载、叠加显示。
你可以通过切片浏览、三维视图等方式直观检查分割效果和数据质量。
如需详细操作截图或遇到具体问题，可随时告知！

## 📌 项目简介
- 模型基于 [Segment Anything Model (SAM)](https://github.com/facebookresearch/segment-anything)，并针对医学图像进行了适配与微调。  
- 支持 **单 GPU / 多 GPU** 训练与推理。  
- 实验任务涵盖 **CT、MRI、病理切片、显微镜图像** 等多种模态。  

--- 

## ⚙️ 环境配置
```bash
``` 
